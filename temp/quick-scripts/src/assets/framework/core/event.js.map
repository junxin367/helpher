{"version":3,"sources":["assets\\framework\\core\\event.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\r\nclass EventManager {\r\n\r\n    private _eventList: { [key: string]: Array<{ listen: Function, target: any }> };\r\n\r\n    public constructor() {\r\n        this._eventList = {};\r\n    }\r\n\r\n    public on(key: any, listen: Function, target?: any) {\r\n        if (this._eventList[key] != null) {\r\n            let array = this._eventList[key];\r\n            array.push({ listen: listen, target: target });\r\n        } else {\r\n            let array = new Array<any>();\r\n            array.push({ listen: listen, target: target });\r\n            this._eventList[key] = array;\r\n        }\r\n    }\r\n\r\n    public off(key: any, listener?: any, target?: any) {\r\n        if (listener != null && !(listener instanceof Function)) {\r\n            target = listener;\r\n            listener = null;\r\n        }\r\n        if (this._eventList[key] != null) {\r\n            if (listener == null && target == null) {\r\n                delete this._eventList[key];\r\n            } else {\r\n                let array = this._eventList[key];\r\n                for (let i = array.length - 1; i >= 0; i--) {\r\n                    if (listener != null && target != null) {\r\n                        if (array[i].listen == listener && array[i].target == target) {\r\n                            array.splice(i, 1);\r\n                        }\r\n                    } else if (listener != null && array[i].listen == listener) {\r\n                        array.splice(i, 1);\r\n                    } else if (target != null && array[i].target == target) {\r\n                        array.splice(i, 1);\r\n                    }\r\n                }\r\n                if (array.length == 0) {\r\n                    delete this._eventList[key]\r\n                }\r\n            }\r\n        } else {\r\n            this.offTarget(key);\r\n        }\r\n    }\r\n\r\n    public offTarget(target) {\r\n        for (let k in this._eventList) {\r\n            let listeners = this._eventList[k]\r\n            this._eventList[k] = listeners.filter(v => v.target != target)\r\n            let array = this._eventList[k];\r\n            if (array.length == 0) {\r\n                delete this._eventList[k]\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    public emitDelay(delay: number, tag: string, ...params: any[]) {\r\n        setTimeout(v => {\r\n            this.emit(tag, ...params);\r\n        }, delay * 1000)\r\n    }\r\n\r\n    public emit(tag: any, ...params: any[]) {\r\n        let sendOk: boolean = false;\r\n        if (this._eventList[tag] != null) {\r\n            let array = this._eventList[tag];\r\n            // if (!cc.sys.isMobile) { console.warn(\"emit message: \", tag, params); }\r\n            for (let i = 0; i < array.length; i++) {\r\n                let obj = array[i];\r\n                if (obj.target != null) {\r\n                    if (obj.listen.apply(obj.target, params))\r\n                        sendOk = true\r\n                }\r\n                else {\r\n                    if (obj.listen.apply(this, params))\r\n                        sendOk = true\r\n                }\r\n            }\r\n        }\r\n        return sendOk\r\n    }\r\n\r\n    /**有可能会拦截消息并停止转发 */\r\n    wait(msg: any, timeoutSec = 0): Promise<any> {\r\n        return new Promise((resolve, reject) => {\r\n            let self = this;\r\n            let timeoutId = 0;\r\n            let callback = function (...params) {\r\n                evt.off(msg, callback, self);\r\n                if (timeoutId) {\r\n                    clearTimeout(timeoutId);\r\n                }\r\n                resolve(params)\r\n            }\r\n            if (timeoutSec > 0) {\r\n                timeoutId = setTimeout(v => {\r\n                    evt.off(msg, callback, self);\r\n                    resolve('timeout')\r\n                }, timeoutSec * 1000)\r\n            }\r\n            evt.on(msg, callback, this);\r\n        })\r\n    }\r\n\r\n    sleep(timeout) {\r\n        return new Promise((resolve, reject) => {\r\n            timeout = timeout < 0 ? 0 : timeout;\r\n            setTimeout(() => {\r\n                resolve()\r\n            }, timeout * 1000)\r\n        })\r\n    }\r\n\r\n    sleepSafe(comp, timeout) {\r\n        return new Promise((resolve, reject) => {\r\n            timeout = timeout < 0 ? 0 : timeout;\r\n            comp.scheduleOnce(() => {\r\n                resolve();\r\n            }, timeout)\r\n        })\r\n    }\r\n}\r\nexport var evt = new EventManager();\r\nwindow['evt'] = evt;"]}