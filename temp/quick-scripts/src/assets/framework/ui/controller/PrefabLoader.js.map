{"version":3,"sources":["assets\\framework\\ui\\controller\\PrefabLoader.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import Signal from \"../../core/Signal\";\r\nimport ccUtil from \"../../utils/ccUtil\";\r\n\r\nconst { ccclass, property, menu, executeInEditMode } = cc._decorator;\r\nconst ResListEnum = cc.Enum({});\r\n\r\nexport interface PrefabLoaderDelegate {\r\n    onLoadPrefab(lvIndex, path);\r\n}\r\n\r\n@ccclass\r\n@executeInEditMode()\r\nexport default abstract class PrefabLoader extends cc.Component {\r\n    static path_assets = {}\r\n    static path = \"\";\r\n\r\n    // @property({ serializable: true })\r\n    // public _maxLevel: number = 0;\r\n    // @property\r\n    // get maxLevel() {\r\n    //     if (this.assets == null) {\r\n    //         return this._maxLevel;\r\n    //     }\r\n    //     return this.assets.length;\r\n    // }\r\n\r\n    // set maxLevel(v) {\r\n    //     this._maxLevel = v;\r\n    // }\r\n\r\n    @property\r\n    public prefix: string = \"Lv\"\r\n\r\n    @property\r\n    _resIndex = 1;\r\n    @property({ type: ResListEnum })\r\n    get level() {\r\n        return this._resIndex;\r\n    }\r\n\r\n    _delegate: PrefabLoaderDelegate = null;\r\n\r\n    set delegate(v: PrefabLoaderDelegate) {\r\n        this._delegate = v;\r\n    }\r\n\r\n    get assets(): [] {\r\n        if (PrefabLoader.path_assets == null) {\r\n            return\r\n        }\r\n        let derivedClass = this[\"__proto__\"].constructor\r\n        var assets = PrefabLoader.path_assets[derivedClass.path];\r\n        return assets;\r\n    }\r\n\r\n    onLevelLoaded: Signal = new Signal();\r\n    set level(v) {\r\n        // if (this._resIndex == v) return;\r\n        this._resIndex = v\r\n        this._resIndex = this._resIndex < 0 ? 0 : this._resIndex;\r\n        // if (this.maxLevel > 0) {\r\n        // this._resIndex = this._resIndex > this.maxLevel - 1 ? this.maxLevel - 1 : this._resIndex;\r\n        // }\r\n        this.reloadLevel();\r\n    }\r\n\r\n\r\n    loadLevelInstance(levelPrefab) {\r\n        var node = cc.instantiate(levelPrefab)\r\n        node.setParent(this.node);\r\n        try {\r\n            this.onLevelLoaded.fire(node, this._resIndex);\r\n        } catch (e) {\r\n            console.error(e)\r\n        }\r\n    }\r\n\r\n    /** 一般用于测试 */\r\n    loadPrefab(path) {\r\n        this.node.destroyAllChildren();\r\n        cc.resources.release(path);\r\n        ccUtil.getRes(path, cc.Prefab).then(v => {\r\n            this.loadLevelInstance(v)\r\n        })\r\n    }\r\n\r\n    reloadLevel() {\r\n        this.node.destroyAllChildren();\r\n        if (CC_EDITOR) {\r\n            this.loadLevel();\r\n        } else {\r\n            this.scheduleOnce(this.loadLevel);\r\n        }\r\n    }\r\n\r\n    loadLevel() {\r\n        if (this.assets) {\r\n            var levelPrefab = this.assets[this._resIndex]\r\n            this.loadLevelInstance(levelPrefab)\r\n        } else {\r\n            let derivedClass = this[\"__proto__\"].constructor\r\n            if (this._delegate) {\r\n                let res = this._delegate.onLoadPrefab(this._resIndex, derivedClass.path)\r\n                if (res instanceof Promise) {\r\n                    res.then(v => {\r\n                        this.loadLevelInstance(v);\r\n                    })\r\n                } else {\r\n                    this.loadLevelInstance(res);\r\n                }\r\n            } else {\r\n                // if no delegate  prefab-create using prefix + index  as a path\r\n                cc.resources.loadDir(derivedClass.path + \"/\" + this.prefix + (this._resIndex), cc.Prefab, (error, res) => {\r\n                    if (error) {\r\n                        console.error(error);\r\n                        return;\r\n                    }\r\n                    console.log(res);\r\n                    this.loadLevelInstance(res)\r\n                });\r\n            }\r\n\r\n        }\r\n    }\r\n\r\n    nextLevel() {\r\n        this.level++;\r\n    }\r\n\r\n    prevLevel() {\r\n        this.level--;\r\n    }\r\n\r\n    static loadPrefabList(path) {\r\n        cc.resources.loadDir(path, cc.Prefab, (error, res) => {\r\n            this.path_assets[path] = res;\r\n            let array = res.map((item, i) => {\r\n                return { name: item.name, value: i };\r\n            });\r\n            //@ts-ignore\r\n            cc.Class.Attr.setClassAttr(this, 'level', 'enumList', array);\r\n        });\r\n    }\r\n\r\n    public static register(cls, path, debug?) {\r\n        //TODO: 真机上优化\r\n        cls.path = path;\r\n        cc.game.on(cc.game.EVENT_ENGINE_INITED, () => {\r\n            if (CC_EDITOR || debug) {\r\n                //cls.loadPrefabList(path)\r\n            }\r\n        })\r\n    }\r\n}\r\n\r\n"]}