{"version":3,"sources":["assets\\framework\\misc\\DynamicMap.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import Signal from \"../core/Signal\";\r\nimport ccUtil from \"../utils/ccUtil\";\r\n\r\nconst { ccclass, property, menu } = cc._decorator;\r\n\r\nenum Direction {\r\n    Horizontal,//left to right\r\n    Vertical // bottom to top\r\n}\r\n\r\n@ccclass\r\n@menu(\"gamelib/DynamicMap\")\r\nexport default class DynamicMap extends cc.Component {\r\n\r\n    curSeg: cc.Node;\r\n    nextSeg: cc.Node = null\r\n    segIdx: number = -1;\r\n    @property(cc.Prefab)\r\n    segments: cc.Prefab[] = []\r\n    // 从哪里开始创建 \r\n    @property({ displayName: 'start' })\r\n    cursor: number = -1;\r\n\r\n    //是否是无尽\r\n    isInfinite: boolean = false;\r\n\r\n    @property({ type: cc.Enum(Direction) })\r\n    dir: Direction = Direction.Horizontal;\r\n\r\n    signal: Signal = new Signal();\r\n\r\n    isEnd: boolean = false;\r\n\r\n    running: boolean = false;\r\n\r\n    isLoadOnce: boolean = false;\r\n\r\n    onLoad() { }\r\n    onDestroy() {\r\n        this.signal.clear()\r\n    }\r\n    start() {\r\n        if (this.dir == Direction.Horizontal) {\r\n            if (this.cursor < 0) {\r\n                this.cursor = cc.visibleRect.width;\r\n            }\r\n        } else {\r\n            if (this.cursor < 0)\r\n                this.cursor = cc.visibleRect.height;\r\n        }\r\n    }\r\n\r\n    /**bLoadAll 是否一次性加载地图 */\r\n    begin(bLoadAll) {\r\n        this.running = true;\r\n        this.isLoadOnce = bLoadAll;\r\n        //开始生成关卡\r\n        console.warn(\"开始生成关卡\")\r\n        let segcount = this.segments.length;\r\n        if (bLoadAll) {\r\n            for (var i = 0; i < segcount + 1; i++) {\r\n                this.curSeg = this.createNextSeg();\r\n            }\r\n        } else {\r\n            if (this.curSeg == null) {\r\n                this.curSeg = this.createNextSeg();\r\n            }\r\n        }\r\n    }\r\n\r\n    addSements(...prefabs: cc.Prefab[]) {\r\n        this.segments.push(...prefabs);\r\n    }\r\n\r\n    _addToSeg() {\r\n        //get random prefab\r\n        // this.levels.push(prefab);\r\n    }\r\n\r\n    next() {\r\n        // this._addToSeg();\r\n    }\r\n\r\n    createNextSeg() {\r\n\r\n        let idx = this.segIdx + 1\r\n        if (idx > this.segments.length - 1) {\r\n            if (this.isInfinite) {\r\n                this.next();\r\n            } else {\r\n                //没有关卡了\r\n                console.log(\"没有关卡段了\")\r\n                this.isEnd = true;\r\n                this.signal.fire(\"end\", this.cursor)\r\n                return;\r\n            }\r\n        }\r\n\r\n        this.segIdx = cc.misc.clampf(idx, 0, this.segments.length - 1);\r\n        let prefab = this.segments[this.segIdx]\r\n        console.warn(\"create next level:\", prefab.name);\r\n        let node = cc.instantiate(prefab)\r\n        // let roadType = this.levels_roadAvatar[this.levelIndex]\r\n        if (node == null) {\r\n            console.error(\"create segment failed:\", this.segments, this.segIdx)\r\n            return null;\r\n        }\r\n        if (this.dir == Direction.Horizontal) {\r\n            node.setPosition(this.cursor, 0);\r\n            this.cursor += node.width - 8;\r\n        } else {\r\n            node.setPosition(0, this.cursor);\r\n            this.cursor += node.height - 8;\r\n        }\r\n        this.signal.fire(\"newSegCreated\", node);\r\n        //删除\r\n        this.segments.shift();\r\n        this.segIdx -= 1\r\n        node.name = prefab.name;\r\n        node.setParent(this.node);\r\n        return node\r\n    }\r\n\r\n    /**在camera 左边 */\r\n    isOutOfCameraLeft(node) {\r\n        let camera = cc.Camera.main;\r\n        // var rect = node.getBoundingBoxToWorld();\r\n        var rect = ccUtil.getWorldBoundingBox(node);\r\n        var p = camera.getWorldToCameraPoint(cc.v2(rect.xMax, 0), cc.Vec2.ZERO);\r\n        if (p.x < 0) {\r\n            return true\r\n        }\r\n        return false\r\n    };\r\n\r\n    update() {\r\n        if (this.isLoadOnce) return;\r\n        if (!this.running) return;\r\n        for (let i = 0; i < this.node.childrenCount; i++) {\r\n            const child = this.node.children[i]\r\n            if (this.curSeg == child) continue;\r\n            if (this.nextSeg == child) continue;\r\n            let b = this.isOutOfCameraLeft(child);\r\n            if (b) {\r\n                console.warn(\"remove segment\")\r\n                this.signal.fire('removeSeg', child)\r\n                child.destroy();\r\n            }\r\n        }\r\n        if (this.isEnd) return;\r\n        //vertical  check \r\n        // let h = cc.visibleRect.height;\r\n        // let p = cc.Camera.main.getCameraToWorldPoint(cc.v2(0, h), cc.Vec2.ZERO);\r\n\r\n        //horizentl check\r\n\r\n        let end\r\n        let segEnd\r\n        if (this.dir == Direction.Horizontal) {\r\n            let w = cc.visibleRect.width;\r\n            end = cc.Camera.main.getCameraToWorldPoint(cc.v2(w, 0), cc.Vec2.ZERO).x\r\n            // segEnd = this.curSeg.getBoundingBoxToWorld().xMax;\r\n            segEnd = ccUtil.getWorldBoundingBox(this.curSeg).xMax;\r\n        } else {\r\n            let h = cc.visibleRect.height;\r\n            end = cc.Camera.main.getCameraToWorldPoint(cc.v2(0, h), cc.Vec2.ZERO).y;\r\n            // segEnd = this.curSeg.getBoundingBoxToWorld().yMax;\r\n            segEnd = ccUtil.getWorldBoundingBox(this.curSeg).yMax;\r\n        }\r\n\r\n        if (segEnd - end <= 10) {\r\n            if (this.nextSeg == null) {\r\n                //create next \r\n                this.nextSeg = this.createNextSeg()\r\n            }\r\n        }\r\n        if (segEnd - end <= 0) {\r\n            //enter next \r\n            // console.log(\"enter next level\");\r\n            this.curSeg = this.nextSeg\r\n            this.nextSeg = null;\r\n        }\r\n        // check bounding\r\n\r\n    }\r\n}"]}