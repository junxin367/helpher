{"version":3,"sources":["assets\\framework\\extension\\buffs\\BuffSystem.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import BuffBase from \"./Buff\";\r\n\r\nimport Buff from \"./Buff\";\r\nimport EmptyBuff from \"./EmptyBuff\";\r\nconst { ccclass, property } = cc._decorator;\r\n/**\r\n * TODO:\r\n// BuffManager.register(OutputSpeedupBuff, ()=>PlayerInfo.buff_outputSpeed = this.timeLeft);\r\n */\r\n\r\n\r\nexport let buffSystem: BuffSystem = null;\r\n\r\n@ccclass\r\nexport default class BuffSystem extends cc.Component {\r\n    private buffs: { [index: string]: BuffBase } = {}\r\n\r\n    private static buff_cls = {}\r\n    private static buff_cls_data = {}\r\n\r\n    onLoad() {\r\n        buffSystem = this;\r\n        this.load();\r\n    }\r\n\r\n    protected onEnable() {\r\n        this.schedule(this.step, 1)\r\n    }\r\n\r\n    protected onDisable() {\r\n        this.unschedule(this.step);\r\n    }\r\n\r\n    protected step() {\r\n        let now = Date.now() / 1000;\r\n        for (var i in this.buffs) {\r\n            let buf = this.buffs[i]\r\n            if (buf.isEnabled) {\r\n                buf.doStep(now);\r\n                if (!buf.isEnabled) {\r\n                    buf.disable();\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public static register(name, cls, data = null) {\r\n        BuffSystem.buff_cls[name] = cls;\r\n        BuffSystem.buff_cls_data[name] = data;\r\n    }\r\n\r\n    private _create(buffname) {\r\n        let cls = BuffSystem.buff_cls[buffname];\r\n        if (cls == null) {\r\n            if (typeof (buffname) == \"string\") {\r\n                console.error(\"[BuffSystem]:\" + buffname + \"未注册 ！\")\r\n                return new EmptyBuff();\r\n            } else {\r\n                return new buffname;\r\n            }\r\n        } else {\r\n            let data = BuffSystem.buff_cls_data[buffname]\r\n            let buff = new cls() as Buff;\r\n            buff.name = buffname;\r\n            buff.data = data;\r\n            return buff;\r\n        }\r\n    }\r\n\r\n    getBuff(buffname) {\r\n        let buf = this.buffs[buffname]\r\n        if (!buf) {\r\n            buf = this._create(buffname);\r\n            this.buffs[buffname] = buf\r\n        }\r\n        return buf;\r\n    }\r\n\r\n    /**第一个参数 必然是duration  */\r\n    startBuff(buffname, ...a) {\r\n        let buf = this.getBuff(buffname);\r\n        if (buf.isEnabled) {\r\n            if (buf.canAdd) {\r\n                buf.addLife(a[0])\r\n            } else {\r\n                buf.resetLife();\r\n            }\r\n        } else {\r\n            buf.enable(...a)\r\n        }\r\n        return buf;\r\n    }\r\n\r\n\r\n    stop(buffname) {\r\n        let buf = this.getBuff(buffname)\r\n        if (buf.isEnabled)\r\n            buf.disable();\r\n    }\r\n\r\n    save() {\r\n        console.log(this.buffs);\r\n        for (var k in this.buffs) {\r\n            let v = this.buffs[k];\r\n            v.save();\r\n        }\r\n        //保存离线时间 \r\n        localStorage.setItem(\"buffSys.lastTime\", Date.now().toString());\r\n    }\r\n\r\n\r\n    load() {\r\n        let last = localStorage.getItem(\"buffSys.lastTime\")\r\n        let lastTime;\r\n        if (last == null || last == \"\") {\r\n            lastTime = Date.now();\r\n        } else {\r\n            lastTime = parseInt(last);\r\n        }\r\n        let now = Date.now();\r\n        let offset = (now - lastTime) / 1000;\r\n        if (offset < 0) return;\r\n        for (var k in BuffSystem.buff_cls) {\r\n            let inst = this.getBuff(k);\r\n            if (inst) {\r\n                inst.load(offset);\r\n                inst.recovery();\r\n            } else {\r\n                console.warn(\"error load buff:\" + k)\r\n            }\r\n\r\n        }\r\n    }\r\n}"]}