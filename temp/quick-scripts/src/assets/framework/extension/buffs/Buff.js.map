{"version":3,"sources":["assets\\framework\\extension\\buffs\\Buff.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import Signal from \"../../core/Signal\";\r\n\r\nenum EventType {\r\n    Start,\r\n    End,\r\n    Update\r\n}\r\n\r\nexport default abstract class Buff {\r\n    static EventType: typeof EventType = EventType;\r\n    duration: number = 10;\r\n    finished: boolean = true;\r\n\r\n\r\n    timeLeft: number = 0;\r\n\r\n    //buff 名称 \r\n    name: string = \"\";\r\n\r\n    //可以是任何数据 \r\n    data: any;\r\n\r\n    /** 可叠加 */\r\n    canAdd: boolean = false;\r\n\r\n    /** 最多可叠加 多长时间 */\r\n    maxDuration: number = 0;\r\n\r\n    //buff 刷新 间隔\r\n    interval: number = 1;\r\n\r\n    signals: { [index: number]: Signal } = {\r\n        [EventType.Start]: new Signal(),\r\n        [EventType.End]: new Signal(),\r\n        [EventType.Update]: new Signal()\r\n    }\r\n\r\n\r\n    get isEnabled() {\r\n        return this.timeLeft > 0;\r\n    }\r\n\r\n    abstract onEnabled(...a)\r\n    abstract onDisabled()\r\n    step() { }\r\n    abstract onTimeLeftChanged();\r\n\r\n    onRecovery() { }\r\n    onReset() { }\r\n    save() { }\r\n    load(offlineSec) { }\r\n\r\n    pause() {\r\n    }\r\n\r\n    resume() {\r\n    }\r\n\r\n\r\n\r\n    on(type: EventType, callback, target) {\r\n        this.signals[type].add(callback, target)\r\n    }\r\n\r\n    off(type: EventType, callback, target) {\r\n        this.signals[type].remove(callback, target)\r\n    }\r\n\r\n    private _emit(type: EventType, ...ps) {\r\n        this.signals[type].fire(...ps);\r\n    }\r\n\r\n    beganTimeSec: number = 0;\r\n\r\n    /**增加buff 生命周期  */\r\n    addLife(life) {\r\n        // if (this.duration + life < this.maxDuration) {\r\n        this.duration += life;\r\n        this.timeLeft += life;\r\n        // }\r\n    }\r\n\r\n    recovery() {\r\n        if (this.timeLeft <= 0) return;\r\n        this.duration = this.timeLeft;\r\n        this.finished = false;\r\n        this.beganTimeSec = Date.now() / 1000;\r\n        this.onRecovery();\r\n        this.onTimeLeftChanged();\r\n        console.warn(\"[BuffSystem]恢复buff:\" + \"[\" + this.name + \"]\", this.duration);\r\n    }\r\n\r\n    /**重置 buff 生命 周期  */\r\n    resetLife() {\r\n        this.beganTimeSec = Date.now() / 1000;\r\n        this.finished = false;\r\n        this.timeLeft = this.duration;\r\n        this.onReset();\r\n    }\r\n\r\n    enable(duration?, ...a) {\r\n        this.duration = parseInt(duration) || this.duration;\r\n        this.resetLife()\r\n        this.onEnabled(...a);\r\n        this.onTimeLeftChanged()\r\n        this._emit(EventType.Start, this)\r\n        console.warn(\"[BuffSystem]开启buff:\" + \"[\" + this.name + \"]\", this.duration);\r\n    }\r\n\r\n    disable() {\r\n        this.finished = true;\r\n        this.timeLeft = 0\r\n        try {\r\n            this.onDisabled();\r\n            this.onTimeLeftChanged()\r\n        } catch (e) {\r\n            console.warn(e)\r\n        }\r\n        this._emit(EventType.End, this);\r\n        console.warn(\"[BuffSystem]关闭buff:\" + \"[\" + this.name + \"]\");\r\n    }\r\n\r\n    doStep(now) {\r\n        if (this.finished) return;\r\n        if (this.timeLeft > 0) {\r\n            this.timeLeft = this.duration - (now - this.beganTimeSec);\r\n            this.step()\r\n            this._emit(EventType.Update, this)\r\n            this.onTimeLeftChanged()\r\n        }\r\n    }\r\n\r\n\r\n}"]}