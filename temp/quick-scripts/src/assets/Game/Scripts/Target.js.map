{"version":3,"sources":["assets\\Game\\Scripts\\Target.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { evt } from \"../../framework/core/event\";\r\nimport SkeletonBase from \"./SkeletonBase\";\r\nimport FSM from \"../../framework/core/FSM\";\r\nimport ccUtil from \"../../framework/utils/ccUtil\";\r\nimport Device from \"../../framework/misc/Device\";\r\nimport AIEnemy from \"./AIEnemy\";\r\nimport Role from \"./Role\";\r\nimport Unity from \"./Common/Unity\";\r\nenum Emotion {\r\n    Normal,\r\n    Happy,\r\n    Frightened\r\n}\r\nlet { ccclass, property } = cc._decorator\r\n@ccclass\r\nexport default class Target extends SkeletonBase {\r\n\r\n    //老头\r\n    // fsm:FSM ;   \r\n    @property\r\n    dir: number = -1;\r\n\r\n    cd: number = 0;\r\n    emotionState: FSM;\r\n    _statusWin: boolean = false;\r\n    _statusLose: boolean = false;\r\n\r\n    baseScale: number = 0;\r\n\r\n    start() {\r\n        evt.on(\"Game.beDected\", this.onDetected, this);\r\n        evt.on(\"Game.win\", this.onWin, this)\r\n        evt.on(\"Game.lose\", this.onGameLose, this);\r\n        evt.on(\"Game.bomb\", this.goDead, this);\r\n        evt.on(\"Game.catch\", this.onCatched, this)\r\n        evt.on(\"Game.loseTarget\", this.onLoseTarget, this)\r\n        evt.on(\"Game.enemyDead\", this.onEnemyDead, this);\r\n        // evt.on(\"Game.seeTarget\", this.onSeeTarget, this)\r\n        this.playAnim(\"idle\")\r\n        this.schedule(this.checkSight, 2)\r\n\r\n        this.baseScale = Math.abs(this.node.scale);\r\n\r\n        this.emotionState = this.addComponent(FSM);\r\n        this.emotionState.init(this, Emotion)\r\n        this.emotionState.enterState(Emotion.Normal)\r\n        this.schedule(this.checkFace, 1);\r\n\r\n        Unity.loadSkins(this.skeleton, 2);\r\n    }\r\n\r\n    onEnable() {\r\n    }\r\n\r\n    shockedAnim: dragonBones.AnimationState = null;\r\n\r\n    onDetected() {\r\n        //被察觉\r\n        this.shockedAnim = this.playAnim(\"shocked\")\r\n        this.scheduleOnce(this.checkEmotion, 4);\r\n    }\r\n\r\n    checkEmotion() {\r\n        if (AIEnemy.allEnemies.length <= 0) {\r\n            this.stopAnim();\r\n            this.playAnim(\"idle\")\r\n        }\r\n    }\r\n\r\n    onCatched(t) {\r\n        if (t == 'target') {\r\n            // this.emotionState.changeState(Emotion.Frightened);\r\n            this.playAnim(\"shocked\")\r\n        }\r\n\r\n    }\r\n\r\n    onLoseTarget() {\r\n        this.playAnim(\"idle\")\r\n    }\r\n\r\n    onEnemyDead() {\r\n        this.stopAnim();\r\n        this.playAnim(\"idle\")\r\n    }\r\n\r\n\r\n    onDestroy() {\r\n        evt.off(this);\r\n    }\r\n\r\n    onWin() {\r\n        this.fadeIn('happy', 0)\r\n        this._statusWin = true;\r\n    }\r\n\r\n    onGameLose() {\r\n        this._statusLose = true;\r\n    }\r\n\r\n    timer: number = 0;\r\n    checkSight() {\r\n        if (this._statusWin || this._statusLose) return;\r\n        this.timer += 2;\r\n        if (this.timer < this.cd) {\r\n            return\r\n        }\r\n        this.timer = 0;\r\n        //能否看到\r\n        let pos = g.v2(ccUtil.getWorldPosition(this.node))\r\n        pos.y += 60;\r\n        let pos2 = pos.clone()\r\n        pos2.x = this.dir * 250;\r\n        let res = this._world.rayCast(pos, pos2, cc.RayCastType.Any)\r\n        for (var k in res) {\r\n            let r = res[k];\r\n            let group = r.collider.node.group;\r\n            if (group == 'role') {\r\n                //看到主角\r\n                this.sayHello()\r\n                // 10s 后不在打招呼\r\n                this.cd = 10;\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    sayHello() {\r\n        this.fadeIn(\"hello\", 1)\r\n        evt.emit(\"Game.hello\", this)\r\n    }\r\n\r\n    onEnter_Happy(state, param) {\r\n        if (param) {\r\n\r\n            this.fadeIn(param, 1)\r\n        } else {\r\n            this.fadeIn(\"happy\", 1)\r\n        }\r\n    }\r\n\r\n    onEnter_Normal() {\r\n        this.fadeIn(\"normal\", 1)\r\n    }\r\n\r\n    onEnter_Frightened() {\r\n        this.fadeIn(\"frightened\", 1);\r\n    }\r\n\r\n    onUpdate_Frightened() {\r\n        if (this.emotionState.timeElapsed > 2.0) {\r\n            this.emotionState.changeState(Emotion.Normal)\r\n        }\r\n    }\r\n\r\n    onUpdate_Happy() {\r\n        if (this.emotionState.timeElapsed > 4.0) {\r\n            this.emotionState.changeState(Emotion.Normal)\r\n        }\r\n    }\r\n\r\n    isDead: boolean = false;\r\n    goDead() {\r\n        if (this.isDead) return;\r\n        this.isDead = true;\r\n        this.playAnim(\"shocked\")\r\n        Device.playSfx(\"ohoh\")\r\n        this.scheduleOnce(this.loseGame, 0.5);\r\n    }\r\n\r\n    loseGame() {\r\n        evt.emit(\"Game.lose\");\r\n    }\r\n\r\n    checkFace() {\r\n        let role = Role.self\r\n        if (!role) return;\r\n        if (Math.abs(role.node.y - this.node.y) > 200) {\r\n            return;\r\n        }\r\n        if (role.node.x > this.node.x) {\r\n            // 在右边\r\n            this.node.scaleX = -1 * this.baseScale;\r\n        } else {\r\n            //左边\r\n            this.node.scaleX = 1 * this.baseScale;\r\n        }\r\n    }\r\n\r\n}"]}