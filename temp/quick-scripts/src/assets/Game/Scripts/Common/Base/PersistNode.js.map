{"version":3,"sources":["assets\\Game\\Scripts\\Common\\Base\\PersistNode.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import StatHepler from \"../../../../framework/extension/aldsdk/StatHelper\";\r\nimport Device from \"../../../../framework/misc/Device\";\r\nimport ViewManager from \"../../../../framework/ui/ViewManager\";\r\nimport { evt } from \"../../../../framework/core/event\";\r\nimport Platform from \"../../../../framework/extension/Platform\";\r\nimport { PlayerInfo } from \"./PlayerInfo\";\r\nimport { UserInfo } from \"../../../../framework/extension/weak_net_game/UserInfo\";\r\nimport BuffSystem from \"../../../../framework/extension/buffs/BuffSystem\";\r\nimport AutoLabour from \"../../level/AutoLabour\";\r\nimport Cloud from \"../../../../framework/extension/mmcloud/Cloud\";\r\nimport { SDKBase } from \"../../../../framework/extension/SDKInterafce\";\r\nimport { GameConfig } from \"../../../../framework/extension/wxsdk/GameConfigs\";\r\nimport DouyinStorage from \"../../../../framework/extension/ttsdk/DouyinStorage\";\r\nimport { ttsdk } from \"../../../../framework/extension/ttsdk/ttsdk\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n//config.csv配置\r\n//BannerAdWhiteList 需要显示banner 的view列表\r\n@ccclass\r\nexport default class PersistNode extends cc.Component {\r\n    isNewUser: boolean = true;\r\n    onLoad() {\r\n        cc.game.addPersistRootNode(this.node)\r\n        cc.game.on(cc.game.EVENT_SHOW, this.onShow, this, false);\r\n        cc.game.on(cc.game.EVENT_HIDE, this.onHide, this, false)\r\n        Device.setAudioPath(\"Audio/\")\r\n        SDKBase.initConfig(GameConfig);\r\n        csv.setParser((type, value) => {\r\n            if (type == \"item\") {\r\n                // let ret = []\r\n                if (typeof (value) == \"string\") {\r\n                    // let vs = value.split(\";\")\r\n                    // vs.forEach(v => {\r\n                    let arr = value.split(\",\")\r\n                    let r = { type: arr[0], id: arr[1], count: parseInt(arr[2]) }\r\n                    // ret.push(r)\r\n                    // })\r\n                    return r\r\n                }\r\n            }\r\n        })\r\n\r\n        BuffSystem.register(\"AutoLabour\", AutoLabour);\r\n\r\n        evt.on(\"wxsdk.BannerReady\", this.onBannerReady, this);\r\n        evt.on(\"View.onShow\", this.onViewShow, this)\r\n        evt.on(\"View.onHidden\", this.onViewHidden, this)\r\n        evt.on(\"Loading.Success\", this.onLoadingSuccess, this);\r\n        this.addComponent(BuffSystem);\r\n        evt.on(\"wx.shareMessageToFriend\", this.onShareToFriend, this);\r\n        evt.on(\"WeakNetGame.ShareSuccess\", this.onShareSuccess, this);\r\n        evt.on(\"WeakNetGame.ShareFail\", this.onShareFail, this);\r\n        evt.on(\"PlayerInfo.labour\", this.onLabour, this);\r\n\r\n        //  douyin \r\n        if (cc.sys.BYTEDANCE_GAME == cc.sys.platform) {\r\n            ttsdk.douyin_sidebar_check();\r\n        }\r\n\r\n    }\r\n\r\n\r\n\r\n    onLabour(num) {\r\n        console.log(\"体力\" + num);\r\n        // if (UserInfo.isUse && PlayerInfo.nowTili < csv.Config.Max_Energy && num >= csv.Config.Max_Energy) {\r\n        //     if (cc.director.getScene().name == 'Game') {\r\n        //         // if (PlayerInfo.isWechat()) vm.show(\"Prefabs/UI/UISubscriber\");\r\n        //     }\r\n        // }\r\n        if (!UserInfo.isUse && num < PlayerInfo.nowTili) {\r\n            // 说明当天消耗过体力\r\n            UserInfo.isUse = true;\r\n            UserInfo.save(\"isUse\");\r\n        }\r\n        PlayerInfo.nowTili = num;\r\n    }\r\n\r\n    onShareFail(key) {\r\n        StatHepler.sendPath(\"用户分享失败次数（获利点分享）\", key)\r\n    }\r\n\r\n    onShareSuccess(key) {\r\n        StatHepler.sendPath(\"用户分享成功次数（获利点分享）\", key)\r\n    }\r\n\r\n    //分享\r\n    onShareToFriend(cb) {\r\n        Platform.share(function (ok) {\r\n            if (ok)\r\n                cb()\r\n        })\r\n    }\r\n\r\n\r\n    onViewShow(view) {\r\n            Platform.hideBannerAd();\r\n    }\r\n\r\n    onViewHidden(view) {\r\n        Platform.hideBannerAd();\r\n        // if (!csv.Config) return;\r\n        // // if (cc.director.getScene().name == \"Game\") return Platform.showBannerAd();\r\n        // if (csv.Config.BannerAdWhiteList && csv.Config.BannerAdWhiteList.indexOf(view.node.name) != -1) {\r\n        //     Platform.hideBannerAd();\r\n        // }\r\n        // evt.emit(\"PersistNode.onViewHidden\")\r\n        // if (csv.Config.BannerAdRefreshWhiteList && csv.Config.BannerAdRefreshWhiteList.indexOf(view.node.name) != -1) {\r\n        //     Platform.refreshBannerAd();\r\n        // }\r\n\r\n    }\r\n    onDestroy() {\r\n        evt.off(this);\r\n    }\r\n\r\n    onBannerReady() {\r\n        if (ViewManager.instance) {\r\n            ViewManager.instance.allViews.forEach(v => {\r\n                // csv.Config.BannerActiveViews\r\n                // csv.Config.ShowBannerViews\r\n                if (v.node.active) {\r\n                    if (csv.Config.BannerAdWhiteList && csv.Config.BannerAdWhiteList.indexOf(v.node.name) == -1) {\r\n                        //没有在白名单里的要隐藏 \r\n                        console.log(v.node.name + \"未在白名单里，隐藏banner\");\r\n                        Platform.hideBannerAd();\r\n                    }\r\n                }\r\n            })\r\n        }\r\n\r\n    }\r\n\r\n    onShow(a) {\r\n        if (this.isHidding) {\r\n            //resume game \r\n            evt.emit(\"Game.Resume\");\r\n            this.isHidding = false;\r\n        }\r\n\r\n    }\r\n\r\n    isHidding: boolean = false;\r\n\r\n    onHide() {\r\n        PlayerInfo.saveExit();\r\n        if (!CC_DEBUG) {\r\n            //强制上传数据\r\n            PlayerInfo.save(null, true);\r\n        }\r\n        this.isHidding = true;\r\n        // UserInfo.exitGame();\r\n        this.unschedule(this.time30);\r\n        this.unschedule(this.time45);\r\n        this.unschedule(this.time60);\r\n        Platform.hideBannerAd();\r\n    }\r\n\r\n    start() {\r\n        // let isn = localStorage.getItem(\"PlayerInfo.guide\")\r\n        // if (isn == null || isn == \"\") {\r\n        //     this.isNewUser = true\r\n        // } else {\r\n        //     this.isNewUser = false;\r\n        // }\r\n        // if (this.isNewUser) {\r\n        //     //开始加载\r\n        //     StatHepler.userAction(\"开始加载\")\r\n        // }\r\n    }\r\n\r\n    onLoadingSuccess() {\r\n        evt.off(\"Loading.Success\", this.onLoadingSuccess, this);\r\n        if (this.isNewUser) {\r\n            this.scheduleOnce(this.time30, 30);\r\n            this.scheduleOnce(this.time45, 45);\r\n            this.scheduleOnce(this.time60, 60);\r\n            StatHepler.userAction(\"加载成功\")\r\n        }\r\n    }\r\n\r\n    time30() {\r\n        StatHepler.userAction(\"30s未退出\")\r\n    }\r\n\r\n    time45() {\r\n        StatHepler.userAction(\"45s未退出\")\r\n    }\r\n\r\n    time60() {\r\n        StatHepler.userAction(\"60s未退出\")\r\n    }\r\n}"]}