{"version":3,"sources":["assets\\Game\\Scripts\\Common\\Base\\LoadingScene.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,gFAA2E;AAC3E,+CAA8C;AAC9C,0DAAuD;AACvD,2CAA0C;AAC1C,yFAAoF;AACpF,mFAAkF;AAClF,gFAA2E;AAC3E,qEAAgE;AAE1D,IAAA,KAAwB,EAAE,CAAC,UAAU,EAAnC,OAAO,aAAA,EAAE,QAAQ,cAAkB,CAAC;AAE5C,IAAI,MAAM,GAAG,KAAK,CAAC;AAGnB;IAA0C,gCAAgB;IAA1D;QAAA,qEAgNC;QA9MG,cAAQ,GAAY,KAAK,CAAC;;IA8M9B,CAAC;IA3MG,6BAAM,GAAN;QACI,iBAAM,MAAM,WAAE,CAAC;QACf,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAA;IAGjE,CAAC;IAEK,gCAAS,GAAf;;;gBACI,IAAI,MAAM,EAAE;oBACR,IAAI,CAAC,MAAM,CAAC,EAAE,EAAE;wBACZ,uCAAuC;wBACvC,8CAA8C;wBAC9C,iDAAiD;wBACjD,0CAA0C;wBAC1C,2CAA2C;qBAC9C;iBACJ;gBACD,IAAI,CAAC,aAAa,EAAE,CAAA;gBACpB,WAAG,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAA;gBAC3B,IAAI,GAAG,CAAC,MAAM,CAAC,aAAa,EAAE;oBAC1B,kBAAQ,CAAC,cAAc,GAAG,KAAK,CAAC;iBACnC;qBAAM;oBACH,kBAAQ,CAAC,cAAc,GAAG,IAAI,CAAC;iBAClC;gBACD,IAAI,EAAE,CAAC,GAAG,CAAC,EAAE,IAAI,EAAE,CAAC,GAAG,CAAC,MAAM,EAAE;oBAC5B,IAAI,mBAAQ,CAAC,YAAY,GAAG,GAAG,CAAC,MAAM,CAAC,eAAe,EAAE;wBACpD,mBAAQ,CAAC,YAAY,IAAI,CAAC,CAAC;wBAC3B,mBAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;wBAC9B,4DAA4D;qBAC/D;iBACJ;;;;KACJ;IAGD,kCAAkC;IAClC,oCAAa,GAAb,UAAc,GAAG,EAAE,GAAG;QAClB,QAAQ,GAAG,EAAE;YACT,KAAK,OAAO;gBACR,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,KAAK,CAAA;gBACzB,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC;gBACpB,MAAM;YACV,KAAK,QAAQ;gBACT,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,MAAM,CAAA;gBAC1B,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC;gBACpB,MAAM;YACV,KAAK,WAAW;gBACZ,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,QAAQ,CAAA;gBAC5B,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC;gBACpB,MAAM;YACV,2BAA2B;YAC3B,+CAA+C;YAC/C,2BAA2B;YAC3B,KAAK,KAAK;gBACN,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,QAAQ,CAAA;gBAC5B,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC;gBACpB,MAAM;YACV,KAAK,cAAc;gBACf,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,QAAQ,CAAA;gBAC5B,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC;gBACpB,MAAM;YACV,KAAK,UAAU;gBACX,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,SAAS,CAAA;gBAC7B,IAAI,CAAC,QAAQ,GAAG,GAAG,CAAC;gBACpB,MAAM;SACb;IACL,CAAC;IAGD,8BAAO,GAAP;QACI,IAAI,IAAI,CAAC,QAAQ,EAAE;YACf,IAAI,CAAC,UAAU,EAAE,CAAC;YAClB,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;SACzB;IACL,CAAC;IAED,4BAAK,GAAL;QACI,IAAI,CAAC,UAAU,EAAE,CAAA;IAErB,CAAC;IAED,gCAAS,GAAT;IACA,CAAC;IAED,qBAAqB;IACrB,iCAAU,GAAV;QACI,IAAI,aAAa,EAAE;YACf,IAAI,OAAO,GAAG,EAAE,CAAC,oBAAoB,EAAE,CAAC;YACxC,IAAI,OAAO,CAAC,KAAK,IAAI,IAAI,EAAE;gBACvB,IAAI,YAAY,GAAG,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBACvC,IAAI,YAAY,EAAE;oBACd,oBAAU,CAAC,QAAQ,CAAC,UAAU,EAAE,YAAY,CAAC,CAAA;iBAChD;aACJ;YACD,iBAAiB;YACjB,4BAA4B;YAC5B,4BAA4B;YAC5B,8BAA8B;YAC9B,IAAI;YACJ,kBAAkB;YAClB,8DAA8D;SACjE;aAAM;YACH,mBAAmB;YACnB,iBAAiB;YACjB,sFAAsF;YACtF,mBAAmB;YACnB,8BAA8B;YAC9B,IAAI;YAEJ,kCAAkC;YAClC,kBAAkB;YAClB,+DAA+D;SAClE;IACL,CAAC;IAED,iCAAU,GAAV;QAAA,iBAuFC;QAtFG,UAAU;QACV,IAAI,CAAC,MAAM,EAAE;YACT,sEAAsE;YACtE,0BAA0B;YAC1B,IAAI;YACJ,qBAAW,CAAC,UAAU,CAAC,2BAAY,CAAC,CAAC;YACrC,IAAI,CAAC,UAAU,EAAE,CAAA;YACjB,qBAAqB;YACrB,IAAI,CAAC,2BAAY,CAAC,aAAa,EAAE;gBAC7B,qBAAW,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,UAAA,CAAC;oBACpC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,CAAA;oBAC3B,GAAG,CAAC,WAAW,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;oBACjC,GAAG,CAAC,WAAW,CAAC,QAAQ,EAAE,KAAK,EAAE,aAAa,CAAC,CAAA;gBACnD,CAAC,CAAC,CAAA;aAEL;YACD,gCAAgC;YAChC,kJAAkJ;YAClJ,iCAAiC;YACjC,UAAU;YACV,IAAI;SACP;QAED,kCAAkC;QAClC,uCAAuC;QACvC,uBAAuB;QACvB,IAAI;QAEJ,IAAI,CAAC,MAAM,EAAE;YACT,OAAO,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAA;YACjC,wBAAwB;YACxB,oBAAoB;YACpB,qBAAW,CAAC,OAAO,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,UAAA,IAAI;gBACxD,MAAM,GAAG,IAAI,CAAC;gBACd,SAAS;gBACT,GAAG,CAAC,WAAW,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;gBACjC,GAAG,CAAC,WAAW,CAAC,QAAQ,EAAE,KAAK,EAAE,aAAa,CAAC,CAAA;gBAC/C,yBAAyB;gBACzB,IAAI,CAAC,IAAI,EAAE;oBACP,UAAU;oBACV,WAAG,CAAC,IAAI,CAAC,eAAe,CAAC,CAAA;oBACzB,KAAI,CAAC,SAAS,EAAE,CAAC;oBACjB,OAAO;iBACV;gBACD,IAAI,IAAI,GAAG,IAAI,CAAC,eAAe,CAAA;gBAC/B,OAAO;gBACP,IAAI,IAAI,IAAI,IAAI,EAAE;oBACd,mBAAmB;oBACnB,IAAI,IAAI,GAAG,uBAAU,CAAC,eAAe,EAAE;wBACnC,SAAS;wBACT,uBAAU,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC;qBACvC;yBAAM;wBACH,QAAQ;wBACR,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAA;qBAClC;iBACJ;qBAAM;oBACH,cAAc;oBACd,oBAAoB;oBACpB,IAAI,uBAAU,CAAC,MAAM,IAAI,KAAK,EAAE;wBAC5B,UAAU;wBACV,uBAAU,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC;qBACvC;yBAAM;wBACH,gBAAgB;wBAChB,uBAAU,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;qBACnC;oBACD,mBAAmB;oBACnB,+BAA+B;iBAClC;gBACD,kBAAkB;gBAClB,mBAAQ,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC;gBAE9C,WAAG,CAAC,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,CAAA;gBAC/B,KAAI,CAAC,SAAS,EAAE,CAAC;YACrB,CAAC,CAAC,CAAC,KAAK,CAAC,UAAA,CAAC;gBACN,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAA;gBAChB,KAAI,CAAC,QAAQ,GAAG,CAAC,CAAC;gBAClB,KAAI,CAAC,KAAK,CAAC,MAAM,GAAG,8EAAgB,CAAC,MAAG,CAAA;YAC5C,CAAC,CAAC,CAAA;YACF,2EAA2E;SAG9E;aAAM;YACH,IAAI,CAAC,aAAa,EAAE,CAAC;YACrB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;SACxB;IAEL,CAAC;IA9MgB,YAAY;QADhC,OAAO;OACa,YAAY,CAgNhC;IAAD,mBAAC;CAhND,AAgNC,CAhNyC,0BAAgB,GAgNzD;kBAhNoB,YAAY","file":"","sourceRoot":"/","sourcesContent":["import LoadingSceneBase from \"../../../../framework/misc/LoadingSceneBase\";\r\nimport { ServerConfig } from \"./ServerConfig\";\r\nimport { evt } from \"../../../../framework/core/event\";\r\nimport { PlayerInfo } from \"./PlayerInfo\";\r\nimport WeakNetGame from \"../../../../framework/extension/weak_net_game/WeakNetGame\";\r\nimport { UserInfo } from \"../../../../framework/extension/weak_net_game/UserInfo\";\r\nimport StatHepler from \"../../../../framework/extension/aldsdk/StatHelper\";\r\nimport Platform from \"../../../../framework/extension/Platform\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\nlet inited = false;\r\n\r\n@ccclass\r\nexport default class LoadingScene extends LoadingSceneBase {\r\n\r\n    canRetry: boolean = false;\r\n\r\n\r\n    onLoad() {\r\n        super.onLoad();\r\n        this.node.on(cc.Node.EventType.TOUCH_END, this.onClick, this)\r\n\r\n\r\n    }\r\n\r\n    async nextScene() {\r\n        if (inited) {\r\n            if (!window.tt) {\r\n                // this.loadSubPackage(\"Audio\", '加载资源')\r\n                //await this.loadSubPackage(\"Img\", \"加载主场景资源\");\r\n                //await this.loadSubPackage(\"ImagePart\", \"加载图片\");\r\n                //await this.loadSubPackage(\"ui\", \"加载背景\");\r\n                //await this.loadSubPackage(\"ske\", \"加载动画\");\r\n            }\r\n        }\r\n        this.loadNextScene()\r\n        evt.emit(\"Loading.Success\")\r\n        if (csv.Config.Forbid_Banner) {\r\n            Platform._bannerEnabled = false;\r\n        } else {\r\n            Platform._bannerEnabled = true;\r\n        }\r\n        if (cc.sys.os == cc.sys.OS_IOS) {\r\n            if (UserInfo.kaipingcount < csv.Config.Show_Kaiping_AD) {\r\n                UserInfo.kaipingcount += 1;\r\n                UserInfo.save(\"kaipingcount\");\r\n                // jsb.reflection.callStaticMethod(\"TXsdk\", \"showSplashAd\");\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    //csv config share_config complete\r\n    loginProgress(evt, ext) {\r\n        switch (evt) {\r\n            case 'login':\r\n                this.label.string = \"登录中\"\r\n                this.progress = 0.1;\r\n                break;\r\n            case 'config':\r\n                this.label.string = \"加载配置\"\r\n                this.progress = 0.2;\r\n                break;\r\n            case 'local_csv':\r\n                this.label.string = \"加载本地配置\"\r\n                this.progress = 0.3;\r\n                break;\r\n            // case 'local_csv_loaded':\r\n            //     this.label.string = \"已加载配置(\" + ext + \")\"\r\n            //     this.progress = 0.5;\r\n            case \"csv\":\r\n                this.label.string = \"加载网络配置\"\r\n                this.progress = 0.5;\r\n                break;\r\n            case 'share_config':\r\n                this.label.string = \"加载分享配置\"\r\n                this.progress = 0.7;\r\n                break;\r\n            case \"complete\":\r\n                this.label.string = \"进入游戏...\"\r\n                this.progress = 0.8;\r\n                break;\r\n        }\r\n    }\r\n\r\n\r\n    onClick() {\r\n        if (this.canRetry) {\r\n            this.startLogin();\r\n            this.canRetry = false;\r\n        }\r\n    }\r\n\r\n    start() {\r\n        this.startLogin()\r\n\r\n    }\r\n\r\n    onDestroy() {\r\n    }\r\n\r\n    /**伪登录，仅用于记录是否点击卡片 */\r\n    checkScene() {\r\n        if (CC_WECHATGAME) {\r\n            let options = wx.getLaunchOptionsSync();\r\n            if (options.scene == 1008) {\r\n                let share_cardid = options.query['id'];\r\n                if (share_cardid) {\r\n                    StatHepler.sendPath(\"分享卡片点击人数\", share_cardid)\r\n                }\r\n            }\r\n            // let params = {\r\n            //     query: options.query,\r\n            //     scene: options.scene,\r\n            //     userId: UserInfo.userId\r\n            // }\r\n            // // 告知服务器点的是谁的分享\r\n            // net.httpPost(ServerConfig.root_url + \"/game/enter\", params)\r\n        } else {\r\n            //for test 模拟点击分享卡片\r\n            // let params = {\r\n            //     query: { id: 1, userId: \"D2BFAF0530E53B74C6FB3B487B475D79\", time: Date.now() },\r\n            //     scene: 1008,\r\n            //     userId: UserInfo.userId\r\n            // }\r\n\r\n            // let d = JSON.stringify(params);\r\n            // // 告知服务器点的是谁的分享\r\n            // net.httpGet(ServerConfig.root_url + \"/game/enter?data=\" + d)\r\n        }\r\n    }\r\n\r\n    startLogin() {\r\n        //do init \r\n        if (!inited) {\r\n            // if (cc.sys.os == cc.sys.OS_IOS || cc.sys.os == cc.sys.OS_ANDROID) {\r\n            //     Platform.initSDK();\r\n            // }\r\n            WeakNetGame.initConfig(ServerConfig);\r\n            this.checkScene()\r\n            //第一进入游戏 的loading 界面 \r\n            if (!ServerConfig.is_local_game) {\r\n                WeakNetGame.downloadCsv(\"Config\").then(v => {\r\n                    console.log(\"加载Config成功！！\")\r\n                    csv.removeIndex(\"Config\", \"Key\");\r\n                    csv.createIndex(\"Config\", \"Key\", \"config_data\")\r\n                })\r\n\r\n            }\r\n            // if (PlayerInfo.isShowSDK()) {\r\n            //     window['zzsdkui'].initSDK(0, '1.0.0', 'https://wxa.332831.com/xsl/wx92b8f834ef8fda71/v1.0.0/config.json', 'wx92b8f834ef8fda71', '', () => {\r\n            //         console.log('sdk加载完成')\r\n            //     });\r\n            // }\r\n        }\r\n\r\n        // if (isEmpty(UserInfo.userId)) {\r\n        //     UserInfo.userId = g.uuid(16, 16)\r\n        //     UserInfo.save();\r\n        // }\r\n\r\n        if (!inited) {\r\n            console.log(\"loading init !!!!!\")\r\n            // login using wx code ,\r\n            //使用openid 登陆可以记录数据 \r\n            WeakNetGame.doLogin(this.loginProgress.bind(this)).then(data => {\r\n                inited = true;\r\n                // 后设置索引 \r\n                csv.removeIndex(\"Config\", \"Key\");\r\n                csv.createIndex(\"Config\", \"Key\", \"config_data\")\r\n                // check save timestamps \r\n                if (!data) {\r\n                    //登录失败，也进入\r\n                    evt.emit(\"Loading.Login\")\r\n                    this.nextScene();\r\n                    return;\r\n                }\r\n                let time = data.save_timestamps\r\n                //是否同步过\r\n                if (time != null) {\r\n                    //上一次同步时间 大于本地保存时间 \r\n                    if (time > PlayerInfo.save_timestamps) {\r\n                        //使用服务器数据\r\n                        PlayerInfo.loadFromJsonObject(data);\r\n                    } else {\r\n                        //使用本地数据\r\n                        console.log(\"使用本地数据 ，服务器不是最新的\")\r\n                    }\r\n                } else {\r\n                    //同步本地数据 到服务器 \r\n                    //如果还未初始化过,需要从服务器拉数据\r\n                    if (PlayerInfo.inited == false) {\r\n                        //新玩家使用服务器\r\n                        PlayerInfo.loadFromJsonObject(data);\r\n                    } else {\r\n                        //老玩家使用之前的userId\r\n                        PlayerInfo.openId = data.openId;\r\n                    }\r\n                    // UserInfo.save();\r\n                    // PlayerInfo.save(null, true);\r\n                }\r\n                // 如果已经订阅 说明已经领取奖励\r\n                UserInfo.isDy = data.isDy ? data.isDy : false;\r\n\r\n                evt.emit(\"Loading.Login\", true)\r\n                this.nextScene();\r\n            }).catch(e => {\r\n                console.error(e)\r\n                this.progress = 0;\r\n                this.label.string = `登录失败，点击屏幕重试！(${e})`\r\n            })\r\n            // jsb.reflection.callStaticMethod(\"GDTsdk\", \"applicationDidBecomeActive\");\r\n\r\n\r\n        } else {\r\n            this.loadNextScene();\r\n            this.canRetry = true;\r\n        }\r\n\r\n    }\r\n\r\n}"]}