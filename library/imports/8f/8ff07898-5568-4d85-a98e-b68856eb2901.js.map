{"version":3,"sources":["assets\\Game\\Scripts\\Common\\Base\\IpChecker.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\r\nimport { ServerConfig } from \"./ServerConfig\";\r\nimport Net, { net } from \"../../../../framework/misc/Net\";\r\nimport WeakNetGame from \"../../../../framework/extension/weak_net_game/WeakNetGame\";\r\nimport { PlayerInfo } from \"./PlayerInfo\";\r\nimport { UserInfo } from \"../../../../framework/extension/weak_net_game/UserInfo\";\r\n//在Config.csv 配置 文件 里需要配置以下属性\r\n//Scene_Forbid_Switch  屏蔽Scene开关\r\n//Scene_Forbid_IDs     屏蔽scene id \r\n//IP_Forbid_Switch     屏蔽ip开关\r\n//IP_Forbid_City       屏蔽ip的城市 \r\n//IP_Refresh_Interval   ip请求频率(天)\r\n//Safe_Mode             安全模式 \r\nexport default class IpChecker {\r\n    static checkSceneFobidden(scene) {\r\n        if (csv.Config.Scene_Forbid_Switch) {\r\n            let b = csv.Config.Scene_Forbid_IDs.indexOf(scene + \"\")\r\n            WeakNetGame.is_forbidden = b >= 0;\r\n        } else {\r\n            WeakNetGame.is_forbidden = false\r\n        }\r\n    }\r\n    // check forbidden\r\n    static checkForbidden(obj) {\r\n        if (csv.Config.IP_Forbid_Switch) {\r\n            let cities = csv.Config.IP_Forbid_City.split(\",\")\r\n            let b = cities.some(v => {\r\n                let i = obj.cname.indexOf(v)\r\n                return i >= 0\r\n            })\r\n            if (b) {\r\n                WeakNetGame.is_forbidden = true\r\n            } else {\r\n                this.checkSceneFobidden(obj.scene)\r\n            }\r\n        } else {\r\n            this.checkSceneFobidden(obj.scene)\r\n        }\r\n        console.log(\"WeakNetGame.scene\", obj.scene);\r\n        console.warn(\"WeakNetGame.is_forbidden\", WeakNetGame.is_forbidden)\r\n        console.warn(\"WeakNetGame.is_safe_mode\", WeakNetGame.is_safe_mode)\r\n    }\r\n\r\n    private static check_safe_mode() {\r\n        //第一关, 为安全模式\r\n        return (!!csv.Config.Safe_Mode) && PlayerInfo.playinglevel == 1\r\n    }\r\n\r\n    //请求ip\r\n    static async checkIp() {\r\n        WeakNetGame.set_safe_check_callback(this.check_safe_mode)\r\n        // 检测 本地 保存的ip \r\n        let jobj = { cip: '', cname: '', scene: 0 }\r\n        var diff = Date.now() - UserInfo.ip_s //86400000 一天\r\n        console.log(UserInfo.ip_cname , UserInfo.ip_addr , diff,csv.Config.IP_Refresh_Interval)\r\n        if (UserInfo.ip_cname == '' || UserInfo.ip_addr == \"\" || diff > 86400000 * csv.Config.IP_Refresh_Interval) {\r\n            //是否是下一天\r\n            let res = await net.httpGet(ServerConfig.ip_api);\r\n            if (res == Net.Code.Timeout) {\r\n                // jobj = await this.getIp2();\r\n                return this.checkIp();\r\n            } else {\r\n                if (res) {\r\n                    try {\r\n                        let jstr = res.substring(res.indexOf(\"{\"), res.indexOf(\"}\") + 1);\r\n                        jobj = JSON.parse(jstr);\r\n                        UserInfo.ip_addr = jobj.cip;\r\n                        UserInfo.save('ip_addr')\r\n                        let detail_res = await net.httpGet(ServerConfig.ip_query + jobj.cip)\r\n                        if (detail_res == Net.Code.Timeout) {\r\n                            return this.checkIp();\r\n                        } else {\r\n                            if (detail_res) {\r\n                                let detail = JSON.parse(detail_res)\r\n                                if (detail.error_code == 0) {\r\n                                    jobj.cname = detail.result.City;\r\n                                    UserInfo.ip_cname = jobj.cname;\r\n                                    UserInfo.ip_s = Date.now();\r\n                                    UserInfo.save('ip_s')\r\n                                    UserInfo.save('ip_cname')\r\n                                }\r\n                            } \r\n                        }\r\n                    }\r\n                    catch (e) {\r\n                        \r\n                    }\r\n                } else {\r\n                    \r\n                }\r\n            }\r\n        } else {\r\n            jobj.cip = UserInfo.ip_addr;\r\n            jobj.cname = UserInfo.ip_cname;\r\n        }\r\n        if (CC_WECHATGAME)\r\n            jobj['scene'] = wx.getLaunchOptionsSync().scene;\r\n        else {\r\n            jobj['scene'] = -1;\r\n        }\r\n        this.checkForbidden(jobj);\r\n        // // 检查是否需要屏蔽\r\n        // net.httpGet(ServerConfig.checkip_url, jobj).then(res => {\r\n        //     if (res) {\r\n        //         let obj = JSON.parse(res)\r\n        //         if (obj) {\r\n        //             UserInfo.is_forbidden = obj.forbidden\r\n        //             WeakNetGame.is_forbidden = UserInfo.is_forbidden;\r\n        //         }\r\n        //     }\r\n        // })\r\n    }\r\n\r\n}"]}