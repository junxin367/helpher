{"version":3,"sources":["assets\\framework\\ui\\View.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import ViewManager from \"./ViewManager\";\r\nimport { evt } from \"../core/event\";\r\nimport UIFunctions from \"./UIFunctions\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class View extends cc.Component {\r\n    // isTouchEnabled: boolean = true;\r\n    emit(e, msg) {\r\n        evt.emit(msg)\r\n    }\r\n\r\n    name: string;\r\n\r\n    @property\r\n    isDialog: boolean = false;\r\n\r\n    @property\r\n    closeOnClick: boolean = false;\r\n\r\n    target: any;\r\n\r\n    @property\r\n    opacity: number = 200;\r\n\r\n\r\n\r\n    @property\r\n    childrenAnimation: boolean = false;\r\n\r\n    @property({ visible: true, displayName: \"topMost\" })\r\n    private _topMost: boolean = false;\r\n\r\n\r\n    touchBlocker: cc.Node = null;\r\n    touchBlockerComp: cc.BlockInputEvents = null;\r\n\r\n\r\n    animations: cc.Animation[] = [];\r\n\r\n    call(event, exp: string) {\r\n        // eval(exp);\r\n        g.execScript(exp);\r\n    }\r\n\r\n    setDelegate(target) {\r\n        this.target = target;\r\n    }\r\n\r\n    emitEvent(e, exp: string) {\r\n        evt.emit(exp);\r\n    }\r\n\r\n    /** 打开其它界面  */\r\n    showUI(e, viewPath) {\r\n        ViewManager.instance.show(viewPath)\r\n    }\r\n\r\n    onLoad() {\r\n\r\n\r\n        if (this.childrenAnimation) {\r\n            this.animations = UIFunctions.getChildrenAnimations(this.node)\r\n        } else {\r\n            var anim = this.node.getComponent(cc.Animation)\r\n            if (anim)\r\n                this.animations.push(anim)\r\n        }\r\n        let components = this.getComponents(cc.Component);\r\n        for (var i = 0; i < components.length; i++) {\r\n            let comp: any = components[i]\r\n            if (comp != this) {\r\n                if (comp.onShown || comp.onShow || comp.onHidden) {\r\n                    this.target = comp;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        /** 点击背景退出弹窗 */\r\n        if (this.isDialog) {\r\n            if (this.closeOnClick) {\r\n                this.node.on(cc.Node.EventType.TOUCH_END, this.hide, this);\r\n                this.node.children[0] && this.node.children[0].addComponent(cc.BlockInputEvents);\r\n            }\r\n        }\r\n\r\n\r\n        if (this.animations.length > 0) {\r\n            // this.touchBlocker = new cc.Node();\r\n            // this.touchBlocker.name = \"TouchBlocker\"\r\n            // this.touchBlocker.width = 2000;\r\n            // this.touchBlocker.height = 2000;\r\n            // this.touchBlockerComp = this.touchBlocker.addComponent(cc.BlockInputEvents)\r\n            // this.node.addChild(this.touchBlocker, 1000)\r\n        }\r\n\r\n    }\r\n\r\n    start() {\r\n        this.touchEnabled = true;\r\n    }\r\n\r\n    init(viewname: string) {\r\n        this.name = viewname;\r\n        let idx = viewname.lastIndexOf(\"/\") + 1\r\n        // idx = Math.max(0,idx);\r\n        this.node.name = viewname.substr(idx)\r\n    }\r\n\r\n    hideAnimationCallback() {\r\n        this.node.active = this.visible;\r\n        ViewManager.instance.checkViewStacks();\r\n    }\r\n\r\n    _isHiding: boolean = false;\r\n\r\n\r\n    /**\r\n     * //如果 实现了view的animation那么需要 animation 去做隐藏\r\n     * 否则会不会有animtion ，系统 将直接 设置 active 为false\r\n     */\r\n    doHideAnimation() {\r\n        // if (!this.isDialog)\r\n        // {\r\n        //todo is in hide animtion return ;\r\n        // if(this.isInHideAnimation())return;\r\n        this.node.active = true;\r\n        this._isHiding = true;\r\n        if (!UIFunctions.doHideAnimations(this.animations, this.hideAnimationCallback, this)) {\r\n            this.node.active = false;\r\n            this._isHiding = false;\r\n            ViewManager.instance.checkViewStacks();\r\n        }\r\n        this.log(\"[View] hide:\", this.name);\r\n        this._visibleDirty = false;\r\n    }\r\n\r\n    isInHideAnimation(): any {\r\n        return this._isHiding\r\n    }\r\n\r\n    onHidden() {\r\n        this._visibleDirty = false;\r\n        if (this.target && this.target.onHidden)\r\n            this.target.onHidden();\r\n        // cc.Component.EventHandler.emitEvents(this.onHiddenEvents,[params]);\r\n    }\r\n\r\n    hide() {\r\n        // super.hide()\r\n        //ViewManager remove dd\r\n        this.touchEnabled = false;\r\n        ViewManager.instance.hide(this.node);\r\n    }\r\n\r\n    _visibleDirty: boolean;\r\n\r\n    get visible() { return this._visibleDirty; }\r\n\r\n\r\n\r\n    set topMost(b) {\r\n        if (this._topMost) this._topMost = b;\r\n        this.node.zIndex = 9999;\r\n    }\r\n\r\n    get topMost() {\r\n        return this._topMost;\r\n    }\r\n\r\n    showAnimationNextFrame(callback) {\r\n        this.scheduleOnce(_ => {\r\n            UIFunctions.doShowAnimations(this.animations, callback)\r\n        }, 0)\r\n    }\r\n\r\n    get touchEnabled() {\r\n        if (this.touchBlocker) {\r\n            return !this.touchBlocker.active\r\n        }\r\n        return true;\r\n    }\r\n\r\n    set touchEnabled(b) {\r\n        if (this.touchBlocker) {\r\n            this.touchBlocker.active = !b\r\n        }\r\n    }\r\n\r\n    // setTouchEnabled(bEnabled){\r\n    //     this.touchBlockerComp.enabled = bEnabled;\r\n    //     // UIFunctions.setTouchEnabled(this.node,bEnabled);\r\n    // }\r\n\r\n    show(...params) {\r\n        this.node.active = true;\r\n        //reset zindex \r\n        if (this.topMost)\r\n            this.node.zIndex = 9999;\r\n        this.log(\"[View] show:\", this.name, params);\r\n        UIFunctions.stopAnimations(this.animations);\r\n\r\n        // call next frames \r\n        // this.showAnimationDelay()\r\n        //确保在widget 更新结束后开始动画 ，\r\n        return new Promise<View>((resolve, reject) => {\r\n            let self = this;\r\n\r\n            let showFinishCallback = function () {\r\n                if (!self.touchEnabled)\r\n                    self.touchEnabled = true;\r\n                let ret = null;\r\n                if (self.target && self.target.onShown) {\r\n                    try {\r\n                        ret = self.target.onShown(...params);\r\n                    } catch (err) {\r\n                        self.error(err)\r\n                    }\r\n                }\r\n                evt.emit(self.node.name + \".onShown\", self, ret, params)\r\n                evt.emit(\"View.onShown\", self, ret, params);\r\n                resolve(self);\r\n            }\r\n            this.showAnimationNextFrame(showFinishCallback)\r\n            this._visibleDirty = true;\r\n            evt.emitDelay(0, self.node.name + \".onShown.Before\", self, params)\r\n            evt.emit(\"View.onShow\", self, params);\r\n            // mvc view \r\n            // let mv = this.getComponent(mvc_View)\r\n            // mv && mv.render()\r\n            if (this.target && this.target.onShow) {\r\n                try {\r\n                    this.target.onShow(...params);\r\n                } catch (err) {\r\n                    this.error(err)\r\n                }\r\n            }\r\n            // cc.Component.EventHandler.emitEvents(this.onShownEvents,[params]);\r\n        })\r\n    }\r\n}\r\n"]}