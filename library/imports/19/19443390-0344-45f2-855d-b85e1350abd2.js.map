{"version":3,"sources":["assets\\framework\\misc\\JoyStick.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import Signal from \"../core/Signal\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n@ccclass\r\nexport default class JoyStick extends cc.Component {\r\n    @property(cc.Node)\r\n    outterCircle: cc.Node = null;\r\n\r\n    @property(cc.Node)\r\n    innerCircle: cc.Node = null;\r\n\r\n    @property({ visible() { return !this.autoRadius } })\r\n    radius: number = 250;\r\n\r\n    @property({ visible() { return !this.autoRadius } })\r\n    innerCircleRadius: number = 20;\r\n\r\n\r\n    real_radius: number = 100;\r\n\r\n    // dynamic Joystick\r\n    @property\r\n    dynamicJoystick: boolean = false;\r\n\r\n    @property\r\n    autoRadius: boolean = true;\r\n\r\n    private _isReleased = true;\r\n\r\n    /**移动到指定位置手指位置 */\r\n    @property({ displayName: \"是否可移动\", tooltip: \"超过范围时，将随手指移动\" })\r\n    bmove = false;\r\n\r\n    onMove: Signal = new Signal();\r\n\r\n    onLoad() {\r\n        if (this.autoRadius) {\r\n            this.radius = this.outterCircle.width / 2;\r\n            this.innerCircleRadius = this.innerCircle.width / 2;\r\n        }\r\n        this.real_radius = this.outterCircle.width / 2;\r\n        this.innerCircle.setPosition(cc.Vec3.ZERO);\r\n        this.node.active = false;\r\n    }\r\n\r\n    set target(v) {\r\n        v.on(cc.Node.EventType.TOUCH_START, this.touchStart, this)\r\n        v.on(cc.Node.EventType.TOUCH_END, this.touchEnd, this)\r\n        v.on(cc.Node.EventType.TOUCH_MOVE, this.touchMove, this)\r\n        v.on(cc.Node.EventType.TOUCH_CANCEL, this.touchCancel, this)\r\n    }\r\n\r\n    start() {\r\n        // this.releaseStick();\r\n    }\r\n\r\n    releaseStick() {\r\n        // let move = cc.moveTo(0.5, cc.Vec2.ZERO);\r\n        // let action = move.easing(cc.easeExponentialOut());\r\n        // this.innerCircle.runAction(action);\r\n        this.innerCircle.setPosition(cc.Vec3.ZERO);\r\n        this._isReleased = true;\r\n\r\n        if (this.dynamicJoystick) {\r\n            this.scheduleOnce(this.delayClose, 0.1)\r\n        }\r\n    }\r\n\r\n    delayClose() {\r\n        this.node.active = false;\r\n    }\r\n\r\n\r\n    _axis: cc.Vec2 = cc.v2();\r\n    _power: number = 0;\r\n\r\n    get power() {\r\n        return this._power;\r\n    }\r\n\r\n    get axis() {\r\n        if (this._isReleased) return cc.Vec2.ZERO;\r\n        let vec = this.innerCircle.getPosition();\r\n        let len = vec.mag();\r\n        if (len == 0) return cc.Vec2.ZERO;\r\n        var power = len / this.radius;\r\n        vec.multiplyScalar(1 / len);\r\n        // this._axis.set(vec.x * power, vec.y * power);\r\n        this._axis = cc.Vec2.multiplyScalar(this._axis, vec, power);\r\n        this._power = power;\r\n        return this._axis;\r\n    }\r\n\r\n    _tmp_moveOffset: cc.Vec2 = cc.v2();\r\n\r\n\r\n    move(p: cc.Vec2) {\r\n        let worldP = p.clone();\r\n        let vec = p.subtract(this._startPos);\r\n        let mag = vec.mag();\r\n        let offset = mag - this.radius;\r\n        if (offset > 0) {\r\n            vec.normalizeSelf();\r\n            if (this.bmove) {\r\n                cc.Vec2.copy(this._tmp_moveOffset, vec);\r\n                offset = mag - this.real_radius;\r\n                if (offset > 0) {\r\n                    this._tmp_moveOffset.multiplyScalar(offset)\r\n                    let v = this.innerCircle.getPosition();\r\n                    this._startPos.x = worldP.x - v.x\r\n                    this._startPos.y = worldP.y - v.y;\r\n                    let pos = this.node.parent.convertToNodeSpaceAR(cc.v3(this._startPos.x, this._startPos.y, 0));\r\n                    this.node.position = pos;\r\n                }\r\n            }\r\n            vec.multiplyScalar(this.radius)\r\n        }\r\n        this.innerCircle.setPosition(vec.x, vec.y);\r\n    }\r\n    _startPos: cc.Vec2 = cc.Vec2.ZERO;\r\n    touch_id: number = null;\r\n    touchStart(e) {\r\n        if (this.touch_id != null && e.getID() != this.touch_id) return;\r\n        // let p = e.getUILocation();\r\n        let p = e.getLocation();\r\n        this._startPos = p;\r\n        this._isReleased = false;\r\n        this.unschedule(this.delayClose);\r\n        this.node.active = true;\r\n        if (this.dynamicJoystick) {\r\n            // converto screen position\r\n            // let pos = this.node.getParent().getComponent(UITransformComponent).convertToNodeSpaceAR(v3(p.x, p.y, 0));\r\n            let pos = this.node.getParent().convertToNodeSpaceAR(p)\r\n            this.node.setPosition(pos);\r\n            // this.node.opacity = 0;\r\n            // this.node.runAction(cc.fadeIn(0.5));\r\n        }\r\n    }\r\n\r\n    touchMove(e) {\r\n        if (this.touch_id != null && e.getID() != this.touch_id) return;\r\n        // let p = e.getUILocation();\r\n        let p = e.getLocation();\r\n        let p0 = e.getPreviousLocation();\r\n        let dx = p.x - p0.x;\r\n        let dy = p.y - p0.y;\r\n        this.onMove.fire(dx, dy)\r\n        this.move(p);\r\n    }\r\n\r\n    touchEnd(p: cc.Vec2) {\r\n        this.releaseStick();\r\n        this.touch_id = null;\r\n    }\r\n\r\n    touchCancel(e) {\r\n        this.releaseStick();\r\n        this.touch_id = null;\r\n    }\r\n\r\n}"]}