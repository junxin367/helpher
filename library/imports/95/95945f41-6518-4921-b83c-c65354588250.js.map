{"version":3,"sources":["assets\\framework\\misc\\LocalLifeSystem.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { evt } from \"../core/event\";\r\nimport Signal from \"../core/Signal\";\r\n\r\nexport class LocalLifeSystem\r\n{\r\n\t//生成一颗星需要的时间 \r\n\tsec_per_live = 60 * 5 ;\r\n\t//最多可得多少颗\r\n\tlive_free_get = 5;\r\n\t\r\n\tmax_freeLives_seconds = this.live_free_get * this.sec_per_live;\r\n\r\n\ttask_runSpawnLives:number;\r\n\r\n\ttask_checkLives:number;\r\n\r\n\tlivesSeconds:number = 0\r\n\tlastLifeSaveTime:number;\r\n\r\n\tisEnabledAutoRecovery = true;\r\n\t\r\n\tpublic recoverySignal = new Signal();\r\n\tinit(liveSec = null,live_free = null)\r\n\t{\r\n\t\tthis.sec_per_live = liveSec || this.sec_per_live\r\n\t\tthis.live_free_get = live_free || this.live_free_get\r\n\t\tthis.max_freeLives_seconds = this.sec_per_live * this.live_free_get;\r\n\t\tthis.livesSeconds = 0\r\n\t\tthis.lastLifeSaveTime = Number(localStorage.getItem(\"sys_life_lastLifeSaveTime\")|| new Date().getTime())\r\n\t\tg.setGlobalInstance(LifeSystem,\"LocalLifeSystem\");\r\n\r\n\t\tevt.on(\"onEnterForeground\",this.onEnterForeground,this)\r\n\t\tthis.onTimeRequested(new Date().getTime());\r\n\t\tconsole.log(\"体力系统初始化\",this);\r\n\t}\r\n\r\n\tonEnterForeground()\r\n\t{\r\n\t\tthis.onTimeRequested(new Date().getTime());\r\n\t}\r\n\r\n\tget nextLifeTime()\r\n\t{\r\n\t\treturn (this.lives + 1) * this.sec_per_live - this.livesSeconds;\r\n\t}\r\n\r\n\tget lives()\r\n\t{\r\n\t\treturn Math.floor(this.livesSeconds / this.sec_per_live)\r\n\t}\r\n\r\n\tsave()\r\n\t{\r\n\t\tthis.lastLifeSaveTime = new Date().getTime();\r\n\t\tlocalStorage.setItem(\"sys_life_lastLifeSaveTime\",this.lastLifeSaveTime+\"\")\r\n\t}\r\n\r\n\tonTimeRequested(time)\r\n\t{\r\n\t\tif (this.lastLifeSaveTime)\r\n\t\t{\r\n\t\t\tlet timeElapsed = Math.floor((time - this.lastLifeSaveTime)/1000)\r\n\t\t\tthis.livesSeconds = Math.min(this.max_freeLives_seconds, timeElapsed)\r\n\t\t}\r\n\t}\r\n\r\n\tstartCheck(callback,target)\r\n\t{\r\n\t\tif(this.task_checkLives) return;\r\n\t\tlet lastHeart = callback.call(target);\r\n\t\tthis.task_checkLives = setInterval(_=>{\r\n\t\t\tlet heart = callback.call(target);\r\n\t\t\tif(lastHeart != heart && heart == this.live_free_get - 1)\r\n\t\t\t{\r\n\t\t\t\tthis.livesSeconds = 0;\r\n\t\t\t\tthis.save();\r\n\t\t\t} \r\n\t\t\tif (heart < this.live_free_get) { \r\n\t\t\t\t// this.checkForSpawnLives();\r\n\t\t\t\tthis.livesSeconds = this.livesSeconds + 1;\r\n\t\t\t\tif ( heart + this.lives > heart)\r\n\t\t\t\t{\r\n\t\t\t\t\tconsole.log(\"获得在线奖励一颗星\",this.lives)\r\n\t\t\t\t\tthis.recoverySignal.fire(this.lives);\r\n\t\t\t\t\tthis.livesSeconds = 0;\r\n\t\t\t\t\tthis.save();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlastHeart = heart;\r\n\t\t},1000)\r\n\t}\r\n\r\n}\r\n\r\nexport var LifeSystem = new LocalLifeSystem();\r\n// \r\n"]}