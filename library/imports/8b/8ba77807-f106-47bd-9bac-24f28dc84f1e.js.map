{"version":3,"sources":["assets\\framework\\misc\\TiledLayer2Objects.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const { ccclass, property, menu } = cc._decorator;\r\n\r\n\r\nexport interface TileAttrs {\r\n    pos: cc.Vec2\r\n    gid: number\r\n    tileId: number\r\n    properties,\r\n    tilexy: cc.Vec2\r\n}\r\n\r\nexport interface TileObjectFactoryInterface {\r\n    createObject(objectLayer: cc.TiledLayer, attrs: TileAttrs);\r\n}\r\n\r\n@ccclass\r\n@menu(\"Tiledmap工具/TiledLayer2Objects\")\r\nexport default class TiledLayer2Objects extends cc.Component {\r\n\r\n    tiledmap: cc.TiledMap;\r\n    objectLayer: cc.TiledLayer;\r\n    mw: number = 0;\r\n    mh: number = 0\r\n    tw: number = 0;\r\n    th: number = 0;\r\n    ht: cc.Vec2;\r\n\r\n    _objectFactory: any;\r\n    onLoad() {\r\n        this.tiledmap = this.getComponent(cc.TiledMap);\r\n        let size = this.tiledmap.getMapSize();\r\n        this.mw = size.width;\r\n        this.mh = size.height;\r\n        let tilesize = this.tiledmap.getTileSize();\r\n        this.tw = tilesize.width;\r\n        this.th = tilesize.height;\r\n        this.ht = cc.v2(this.tw / 2, this.th / 2);\r\n\r\n    }\r\n\r\n    start() {\r\n\r\n    }\r\n\r\n\r\n    IDX(x: cc.Vec2 | number, y?) {\r\n        if (x instanceof cc.Vec2) {\r\n            y = x.y;\r\n            x = x.x;\r\n        }\r\n        let idx = y * this.mw + x\r\n        return idx;\r\n    }\r\n\r\n\r\n    createObjects(layerName, onProgress?): Promise<any> {\r\n        if (this._objectFactory == null) {\r\n            console.log(\"[Tiledlayer2object] no factory provided!\")\r\n            return Promise.reject(\"no factory provided!\");\r\n        }\r\n        this.objectLayer = this.tiledmap.getLayer(layerName)\r\n        this.objectLayer.enabled = false;\r\n\r\n        //从上到下，从左到右\r\n        let sum = 0;\r\n        let promises = []\r\n        let i = 0;\r\n        for (var col = 0; col < this.mw; col++) {\r\n            for (var row = 0; row < this.mh; row++) {\r\n                let tilexy = cc.v2(col, row)\r\n                let gid = this.objectLayer.getTileGIDAt(tilexy);\r\n                if (gid != 0) {\r\n                    //create obj of gid at xy \r\n                    let r = this.createObj(gid, tilexy)\r\n                    if (r) {\r\n                        r.then(v => onProgress && onProgress(++i, sum)).catch(e => console.log(e));\r\n                        promises.push(r);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        sum = promises.length;\r\n        return Promise.all(promises);\r\n    }\r\n\r\n\r\n    setFactory(factory: any) {\r\n        this._objectFactory = factory;\r\n    }\r\n\r\n    createObj(gid: number, tilexy: cc.Vec2): Promise<any> {\r\n        let properties = this.tiledmap.getPropertiesForGID(gid)\r\n        if (!gid) {\r\n            // console.warn(`gid :${gid} has no properties`)\r\n            return;\r\n        }\r\n        let pos = this.objectLayer.getPositionAt(tilexy);\r\n        pos.addSelf(cc.v2(this.ht.x, this.ht.y))\r\n        let attrs = {\r\n            pos, gid, tileId: this.IDX(tilexy), properties, tilexy\r\n        }\r\n        return this._objectFactory.createObject(this.objectLayer, attrs);\r\n    }\r\n\r\n\r\n}"]}